<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Avan√ßado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        /* API Keys Modal Styles */
        .api-keys-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            color: #666;
        }

        .api-key-input {
            margin-bottom: 15px;
        }

        .api-key-input label {
            display: block;
            margin-bottom: 5px;
        }

        .api-key-input input {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .api-key-input a {
            font-size: 12px;
            color: #2196f3;
            text-decoration: none;
        }

        .save-button {
            width: 100%;
            padding: 10px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .save-button:hover {
            background: #1976d2;
        }

        .api-key-button {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Controls Panel */
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        /* Chat Container */
        #chat-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        /* Messages */
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            max-width: 95%;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        .message img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: #e3f2fd;
            margin-left: auto;
        }

        .assistant-message {
            background: #f8f9fa;
            margin-right: auto;
        }

        /* Play Audio Button */
        .play-audio {
            position: absolute;
            right: 5px;
            top: 5px;
            padding: 5px;
            min-width: 30px;
            height: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .play-audio:hover {
            color: #2196f3;
        }

        /* Code Block Styling */
        .code-container {
            position: relative;
            margin: 15px 0;
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2d2d2d;
            padding: 8px 12px;
            color: #fff;
            font-size: 14px;
            border-bottom: 1px solid #3d3d3d;
            height: 32px;
        }

        .code-actions {
            display: flex;
            align-items: center;
            position: relative;
        }

        .code-button {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            height: 24px;
        }

        .code-button:hover {
            background: #555;
        }

        .code-content {
            padding: 12px;
            margin: 0;
            overflow-x: auto;
        }

        .copy-feedback {
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
            pointer-events: none;
        }

        .copy-feedback.show {
            opacity: 1;
        }

        /* Input Controls */
        #input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"], textarea, select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"] {
            flex: 1;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        #recordButton {
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #recordButton.recording {
            background: #ff4444;
        }

        /* Image Upload */
        #image-upload {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px 0;
            border-radius: 4px;
        }

        /* System Prompt Editor */
        #system-prompt-editor {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }

        button:hover {
            background: #1976d2;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #d32f2f;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #666;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: .5; }
            50% { opacity: 1; }
            100% { opacity: .5; }
        }

        /* Hide Audio Player */
        #audioPlayer {
            display: none;
        }
    </style>
</head>
<body>
    <!-- API Keys Modal -->
    <div class="api-keys-modal" id="apiKeysModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="apiKeysTitle">API Keys</h2>
                <button onclick="closeApiModal()" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="api-key-input">
                    <label for="hf-key">Hugging Face API Key</label>
                    <input type="password" id="hf-key" placeholder="hf_...">
                    <a href="https://huggingface.co/settings/tokens" target="_blank">Get Key</a>
                </div>
                <div class="api-key-input">
                    <label for="hyperbolic-key">Hyperbolic API Key</label>
                    <input type="password" id="hyperbolic-key" placeholder="eyJ...">
                    <a href="https://hyperbolic.xyz" target="_blank">Get Key</a>
                </div>
                <div class="api-key-input">
                    <label for="gemini-key">Google AI Studio API Key</label>
                    <input type="password" id="gemini-key" placeholder="AIza...">
                    <a href="https://aistudio.google.com" target="_blank">Get Key</a>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveApiKeys()" class="save-button">Save Keys</button>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="control-row">
            <select id="model-select" onchange="handleModelChange()">
                <option value="gemini-exp-1206">Gemini EXP-1206</option>
                <option value="Qwen/Qwen2.5-72B-Instruct">Qwen 2.5 72B</option>
                <option value="Qwen/QwQ-32B-Preview">QwQ 32B Preview</option>
                <option value="Qwen/Qwen2.5-Coder-32B-Instruct">Qwen 2.5 Coder 32B</option>
                <option value="Qwen/Qwen2-VL-72B-Instruct">Qwen VL 72B</option>
                <option value="Qwen/Qwen2-VL-7B-Instruct">Qwen VL 7B</option>
                <option value="flux-schnell">Flux Schnell</option>
                <option value="flux-dev">Flux Dev</option>
            </select>
            <select id="languageSelect" onchange="changeLanguage()">
                <option value="pt-BR">Portugu√™s</option>
                <option value="en-US">English</option>
                <option value="zh-CN">‰∏≠Êñá</option>
            </select>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="autoplayToggle" checked>
                <label for="autoplayToggle">Autoplay Audio</label>
            </div>
            <select id="system-prompt-select" onchange="handleSystemPromptChange()">
                <option value="">Prompt Padr√£o</option>
            </select>
            <button onclick="toggleSystemPromptEditor()">Editar Prompts</button>
            <button class="danger" onclick="clearChat()">Limpar Chat</button>
        </div>

        <div class="control-row">
            <button onclick="openApiModal()" class="api-key-button">
                üîë API Keys
            </button>
        </div>

        <div class="control-row">
            <input type="text" id="chat-name" placeholder="Nome do chat">
            <select id="chat-history-select" onchange="loadChat()">
                <option value="">Carregar Chat</option>
            </select>
            <button onclick="saveChat()">Salvar Chat</button>
            <button class="danger" onclick="deleteChat()">Excluir Chat</button>
        </div>

        <div id="system-prompt-editor">
            <textarea id="system-prompt-text" placeholder="Digite seu prompt do sistema..."></textarea>
            <div class="control-row" style="margin-top: 10px;">
                <input type="text" id="prompt-name" placeholder="Nome do prompt">
                <button onclick="saveSystemPrompt()">Salvar Prompt</button>
                <button class="danger" onclick="deleteSystemPrompt()">Excluir Prompt</button>
                </div>
        </div>
        
        <div id="image-upload">
            <input type="file" id="file-input" accept="image/*" onchange="handleImageUpload(event)">
            <div id="image-preview"></div>
        </div>
    </div>

    <div id="chat-container">
        <div id="typing-indicator" class="typing-indicator">Assistente est√° digitando...</div>
    </div>

    <div id="input-container">
        <button id="recordButton">üé§</button>
        <input type="text" id="user-input" placeholder="Digite sua mensagem...">
        <button onclick="sendMessage()">Enviar</button>
    </div>

    <audio id="audioPlayer" hidden></audio>

    <script>
        // Interface translations
        const translations = {
            'pt-BR': {
                placeholder: 'Digite sua mensagem...',
                send: 'Enviar',
                thinking: 'Assistente est√° digitando...',
                welcome: 'Ol√°! Como posso ajudar?',
                autoplay: 'Reprodu√ß√£o Autom√°tica',
                apiKeys: 'Chaves API',
                saveKeys: 'Salvar Chaves',
                hfKeyLabel: 'Chave API Hugging Face',
                hyperbolicKeyLabel: 'Chave API Hyperbolic',
                geminiKeyLabel: 'Chave API Google AI Studio'
            },
            'en-US': {
                placeholder: 'Type your message...',
                send: 'Send',
                thinking: 'Assistant is typing...',
                welcome: 'Hello! How can I help?',
                autoplay: 'Autoplay Audio',
                apiKeys: 'API Keys',
                saveKeys: 'Save Keys',
                hfKeyLabel: 'Hugging Face API Key',
                hyperbolicKeyLabel: 'Hyperbolic API Key',
                geminiKeyLabel: 'Google AI Studio API Key'
            },
            'zh-CN': {
                placeholder: 'ËæìÂÖ•Ê∂àÊÅØ...',
                send: 'ÂèëÈÄÅ',
                thinking: 'Âä©ÊâãÊ≠£Âú®ËæìÂÖ•...',
                welcome: '‰Ω†Â•ΩÔºÅÊàëËÉΩÂ∏Æ‰Ω†‰ªÄ‰πàÔºü',
                autoplay: 'Ëá™Âä®Êí≠Êîæ',
                apiKeys: 'APIÂØÜÈí•',
                saveKeys: '‰øùÂ≠òÂØÜÈí•',
                hfKeyLabel: 'Hugging Face APIÂØÜÈí•',
                hyperbolicKeyLabel: 'Hyperbolic APIÂØÜÈí•',
                geminiKeyLabel: 'Google AI Studio APIÂØÜÈí•'
            }
        };

        // Initialize variables
        let currentLanguage = 'pt-BR';
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let currentChunk = 0;
        let textChunks = [];
        let currentBase64Image = null;
        let messageHistory = [];
        let conversationDB = [];

        // Initialize elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const recordButton = document.getElementById('recordButton');
        const audioPlayer = document.getElementById('audioPlayer');
        const autoplayToggle = document.getElementById('autoplayToggle');
        const imageUpload = document.getElementById('image-upload');

        // Initialize API keys from localStorage
        const HF_KEY = localStorage.getItem('HF_KEY') || '';
        const GEMINI_KEY = localStorage.getItem('GEMINI_KEY') || '';
        const QWEN_KEY = localStorage.getItem('HYPERBOLIC_KEY') || '';

        // API Keys Modal Functions
        function openApiModal() {
            document.getElementById('apiKeysModal').style.display = 'flex';
            document.getElementById('apiKeysTitle').textContent = translations[currentLanguage].apiKeys;
            
            // Load existing keys
            document.getElementById('hf-key').value = localStorage.getItem('HF_KEY') || '';
            document.getElementById('hyperbolic-key').value = localStorage.getItem('HYPERBOLIC_KEY') || '';
            document.getElementById('gemini-key').value = localStorage.getItem('GEMINI_KEY') || '';
        }

        function closeApiModal() {
            document.getElementById('apiKeysModal').style.display = 'none';
        }

        function saveApiKeys() {
            const hfKey = document.getElementById('hf-key').value;
            const hyperbolicKey = document.getElementById('hyperbolic-key').value;
            const geminiKey = document.getElementById('gemini-key').value;

            if (hfKey) localStorage.setItem('HF_KEY', hfKey);
            if (hyperbolicKey) localStorage.setItem('HYPERBOLIC_KEY', hyperbolicKey);
            if (geminiKey) localStorage.setItem('GEMINI_KEY', geminiKey);

            closeApiModal();
            window.location.reload(); // Refresh to update API key variables
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const modal = document.getElementById('apiKeysModal');
            if (event.target === modal) {
                closeApiModal();
            }
        };

// Initialize markdown
        marked.setOptions({
            headerIds: false,
            mangle: false
        });

        // Initialize
        updateChatSelector();
        loadSystemPrompts();
        handleModelChange();

        // Language and Audio Functions
        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            userInput.placeholder = translations[currentLanguage].placeholder;
            document.querySelector('label[for="autoplayToggle"]').textContent = 
                translations[currentLanguage].autoplay;
        }

        function speakText(text) {
            const maxLength = 200;
            textChunks = [];
            currentChunk = 0;
            
            // Split text into chunks
            for (let i = 0; i < text.length; i += maxLength) {
                textChunks.push(text.slice(i, i + maxLength));
            }
            
            playNextChunk();
        }

        function playNextChunk() {
            if (currentChunk < textChunks.length) {
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=${currentLanguage}&client=tw-ob&q=${encodeURIComponent(textChunks[currentChunk])}`;
                audioPlayer.src = url;
                audioPlayer.playbackRate = 1.5;
                audioPlayer.play();
            }
        }

        audioPlayer.onloadedmetadata = () => {
            audioPlayer.playbackRate = 1.5;
        };

        audioPlayer.onended = () => {
            currentChunk++;
            playNextChunk();
        };

        // Message Handling
        function appendMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;

            if (role === 'assistant') {
                const codeBlocks = extractCodeBlocks(content);
                
                if (codeBlocks.length > 0) {
                    let processedContent = content;
                    codeBlocks.forEach((block, index) => {
                        processedContent = processedContent.replace(block.original, `__CODE_BLOCK_${index}__`);
                    });

                    const parts = processedContent.split('__CODE_BLOCK_');
                    parts.forEach((part, index) => {
                        if (index === 0 && part.trim()) {
                            messageDiv.appendChild(document.createElement('div')).innerHTML = marked.parse(part);
                        } else if (index > 0) {
                            const [blockIndex, ...rest] = part.split('__');
                            if (codeBlocks[blockIndex]) {
                                messageDiv.appendChild(createCodeBlock(codeBlocks[blockIndex].code));
                            }
                            if (rest.join('__').trim()) {
                                messageDiv.appendChild(document.createElement('div')).innerHTML = marked.parse(rest.join('__'));
                            }
                        }
                    });
                } else {
                    messageDiv.innerHTML = marked.parse(content);
                }

                // Add audio button
                const playButton = document.createElement('button');
                playButton.className = 'play-audio';
                playButton.innerHTML = 'üîä';
                playButton.onclick = () => speakText(content);
                messageDiv.appendChild(playButton);

                // Autoplay if enabled
                if (autoplayToggle.checked) {
                    speakText(content);
                }
            } else {
                messageDiv.innerHTML = marked.parse(content);
            }

            chatContainer.insertBefore(messageDiv, document.getElementById('typing-indicator'));
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Code Detection and Handling
        function detectHTML(content) {
            return content.trim().startsWith('<!DOCTYPE html>') && content.trim().endsWith('</html>');
        }

        function extractCodeBlocks(content) {
            const codeBlockRegex = /```(?:html)?\n([\s\S]*?)```/g;
            const blocks = [];
            let match;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                const code = match[1].trim();
                if (detectHTML(code)) {
                    blocks.push({
                        original: match[0],
                        code: code
                    });
                }
            }

            return blocks;
        }

        function createCodeBlock(content, language = 'html') {
            const container = document.createElement('div');
            container.className = 'code-container';

            const codeId = 'code-' + Math.random().toString(36).substring(2, 9);

            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
                <span>Documento HTML</span>
                <div class="code-actions">
                    <div class="copy-feedback">Copiado!</div>
                    <button class="code-button" onclick="copyCode('${codeId}')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Copiar
                    </button>
                </div>
            `;

            const codeContent = document.createElement('pre');
            codeContent.className = 'code-content';
            const codeElement = document.createElement('code');
            codeElement.id = codeId;
            codeElement.className = `language-${language}`;
            codeElement.textContent = content;
            codeContent.appendChild(codeElement);

            container.appendChild(header);
            container.appendChild(codeContent);

            Prism.highlightElement(codeElement);

            return container;
        }

        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            const code = codeElement.textContent;

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = code;
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                const container = codeElement.closest('.code-container');
                const feedback = container.querySelector('.copy-feedback');
                feedback.classList.add('show');
                setTimeout(() => feedback.classList.remove('show'), 2000);
            } catch (err) {
                console.error('Failed to copy code:', err);
            }
            
            document.body.removeChild(tempTextArea);
        }

// STT Functions
        recordButton.addEventListener('click', async () => {
            if (isRecording) {
                stopRecording();
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startRecording(stream);
            } catch (error) {
                console.error('Microphone error:', error);
            }
        });

        function startRecording(stream) {
            audioChunks = [];
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.addEventListener('dataavailable', event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener('stop', async () => {
                const audioBlob = new Blob(audioChunks);
                await transcribeAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            });

            mediaRecorder.start();
            isRecording = true;
            recordButton.classList.add('recording');
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordButton.classList.remove('recording');
            }
        }

        async function transcribeAudio(audioBlob) {
            try {
                const response = await fetch('https://api-inference.huggingface.co/models/openai/whisper-large-v3', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${HF_KEY}`
                    },
                    body: audioBlob
                });

                const data = await response.json();
                if (data.text && data.text.trim()) {
                    sendMessage(data.text);
                }
            } catch (error) {
                console.error('Transcription error:', error);
            }
        }

        // Image Functions
        function handleModelChange() {
            const modelSelect = document.getElementById('model-select');
            const selectedModel = modelSelect.value;
            
            if (selectedModel.includes('VL')) {
                imageUpload.style.display = 'block';
            } else {
                imageUpload.style.display = 'none';
                currentBase64Image = null;
                document.getElementById('image-preview').innerHTML = '';
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentBase64Image = e.target.result;
                    const preview = document.getElementById('image-preview');
                    preview.innerHTML = `<img src="${currentBase64Image}" class="image-preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Chat Management Functions
        function saveChat() {
            const name = document.getElementById('chat-name').value.trim();
            if (!name) {
                alert('Por favor, digite um nome para o chat');
                return;
            }

            const savedChats = JSON.parse(localStorage.getItem('savedChats') || '{}');
            const currentState = {
                display: chatContainer.innerHTML,
                context: messageHistory,
                model: document.getElementById('model-select').value,
                systemPrompt: document.getElementById('system-prompt-select').value,
                currentImage: currentBase64Image
            };
            
            savedChats[name] = currentState;
            localStorage.setItem('savedChats', JSON.stringify(savedChats));
            
            updateChatSelector();
            document.getElementById('chat-name').value = '';
        }

        function loadChat() {
            const select = document.getElementById('chat-history-select');
            const name = select.value;
            if (!name) return;

            const savedChats = JSON.parse(localStorage.getItem('savedChats') || '{}');
            const chatData = savedChats[name];
            
            if (chatData) {
                chatContainer.innerHTML = chatData.display;
                messageHistory = chatData.context;
                document.getElementById('model-select').value = chatData.model;
                document.getElementById('system-prompt-select').value = chatData.systemPrompt;
                currentBase64Image = chatData.currentImage;
                
                const preview = document.getElementById('image-preview');
                preview.innerHTML = currentBase64Image ? 
                    `<img src="${currentBase64Image}" class="image-preview">` : '';
                
                handleModelChange();
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function deleteChat() {
            const select = document.getElementById('chat-history-select');
            const name = select.value;
            if (!name) return;

            const savedChats = JSON.parse(localStorage.getItem('savedChats') || '{}');
            delete savedChats[name];
            localStorage.setItem('savedChats', JSON.stringify(savedChats));
            
            updateChatSelector();
            if (name === select.value) {
                clearChat();
            }
        }

        function updateChatSelector() {
            const savedChats = JSON.parse(localStorage.getItem('savedChats') || '{}');
            const select = document.getElementById('chat-history-select');
            select.innerHTML = '<option value="">Carregar Chat</option>';
            
            Object.keys(savedChats).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

// System Prompt Functions
        function loadSystemPrompts() {
            const savedPrompts = JSON.parse(localStorage.getItem('systemPrompts') || '{}');
            const select = document.getElementById('system-prompt-select');
            select.innerHTML = '<option value="">Prompt Padr√£o</option>';
            
            Object.entries(savedPrompts).forEach(([name, prompt]) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        function handleSystemPromptChange() {
            const select = document.getElementById('system-prompt-select');
            const editor = document.getElementById('system-prompt-text');
            const nameInput = document.getElementById('prompt-name');
            const savedPrompts = JSON.parse(localStorage.getItem('systemPrompts') || '{}');
            
            if (select.value) {
                editor.value = savedPrompts[select.value];
                nameInput.value = select.value;
            } else {
                editor.value = '';
                nameInput.value = '';
            }
        }

        function toggleSystemPromptEditor() {
            const editor = document.getElementById('system-prompt-editor');
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
        }

        function saveSystemPrompt() {
            const name = document.getElementById('prompt-name').value.trim();
            const prompt = document.getElementById('system-prompt-text').value.trim();
            
            if (!name || !prompt) {
                alert('Por favor, digite um nome e um prompt.');
                return;
            }

            const savedPrompts = JSON.parse(localStorage.getItem('systemPrompts') || '{}');
            savedPrompts[name] = prompt;
            localStorage.setItem('systemPrompts', JSON.stringify(savedPrompts));
            
            loadSystemPrompts();
            document.getElementById('system-prompt-select').value = name;
        }

        function deleteSystemPrompt() {
            const select = document.getElementById('system-prompt-select');
            const name = select.value;
            
            if (!name) {
                alert('Por favor, selecione um prompt para excluir.');
                return;
            }

            const savedPrompts = JSON.parse(localStorage.getItem('systemPrompts') || '{}');
            delete savedPrompts[name];
            localStorage.setItem('systemPrompts', JSON.stringify(savedPrompts));
            
            loadSystemPrompts();
            document.getElementById('system-prompt-text').value = '';
            document.getElementById('prompt-name').value = '';
        }

        function clearChat() {
            chatContainer.innerHTML = '<div id="typing-indicator" class="typing-indicator">Assistente est√° digitando...</div>';
            messageHistory = [];
            conversationDB = [];
            currentBase64Image = null;
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('chat-history-select').value = '';
            document.getElementById('chat-name').value = '';
            document.getElementById('user-input').value = '';
            appendMessage(translations[currentLanguage].welcome, 'assistant');
        }

        // Message Sending and API Calls
        async function sendMessage(input) {
            const message = input || userInput.value.trim();
            if (!message) return;

            appendMessage(message, 'user');
            userInput.value = '';

            const typingIndicator = document.getElementById('typing-indicator');
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                let response;
                let aiResponse;
                
                const modelSelect = document.getElementById('model-select');
                const selectedModel = modelSelect.value;
                const systemPromptSelect = document.getElementById('system-prompt-select');
                
                const savedPrompts = JSON.parse(localStorage.getItem('systemPrompts') || '{}');
                const systemPrompt = systemPromptSelect.value ? savedPrompts[systemPromptSelect.value] : '';
        
                let messages = [];
                if (systemPrompt) {
                    messages.push({
                        role: "system",
                        content: systemPrompt
                    });
                }
        
                messages = messages.concat(messageHistory);
                messages.push({ role: "user", content: message });
        
                if (selectedModel === 'flux-schnell' || selectedModel === 'flux-dev') {
                    if (!HF_KEY) {
                        throw new Error('Hugging Face API key is required');
                    }
                    const enhancedPrompt = await enhancePromptWithQwen(message, systemPrompt);
                    const imageUrl = await generateImage(enhancedPrompt, selectedModel);
                    aiResponse = `Prompt aprimorado: ${enhancedPrompt}\n\n![Imagem Gerada](${imageUrl})`;
                } 
                else if (selectedModel === 'gemini-exp-1206') {
                    if (!GEMINI_KEY) {
                        throw new Error('Google AI Studio API key is required');
                    }
                    // Add current message to DB
                    conversationDB.push({
                        role: 'user',
                        content: message
                    });
        
                    // Use entire conversation history without limits
                    const geminiHistory = conversationDB.map(msg => ({
                        role: msg.role === 'assistant' ? 'model' : 'user',
                        parts: [{ text: msg.content }]
                    }));
        
                    response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            contents: geminiHistory,
                            generationConfig: {
                                maxOutputTokens: 32768,
                                temperature: 0.7,
                                topP: 0.9
                            }
                        })
                    });
        
                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                        throw new Error('Invalid response from Gemini API');
                    }
                    aiResponse = data.candidates[0].content.parts[0].text;
                    
                    // Add AI response to DB
                    conversationDB.push({
                        role: 'assistant',
                        content: aiResponse
                    });
                } 
                else {
                    if (!QWEN_KEY) {
                        throw new Error('Hyperbolic API key is required');
                    }
                    response = await fetch('https://api.hyperbolic.xyz/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${QWEN_KEY}`
                        },
                        body: JSON.stringify({
                            model: selectedModel,
                            messages: messages,
                            max_tokens: 4096,
                            temperature: 0.7,
                            top_p: 0.9
                        })
                    });
        
                    const data = await response.json();
                    aiResponse = data.choices[0].message.content;
                }
                
                typingIndicator.style.display = 'none';
                
                const assistantMessage = {
                    role: "assistant",
                    content: aiResponse
                };
                messageHistory.push({ role: "user", content: message });
                messageHistory.push(assistantMessage);
                
                appendMessage(aiResponse, 'assistant');
        
            } catch (error) {
                console.error('Error:', error);
                typingIndicator.style.display = 'none';
                appendMessage(`Error: ${error.message}`, 'assistant');
            }
        }

        // Image Generation Functions
        async function generateImage(prompt, model) {
            const endpoint = model === 'flux-schnell' 
                ? 'black-forest-labs/FLUX.1-schnell'
                : 'black-forest-labs/FLUX.1-dev';

            const response = await fetch(`https://api-inference.huggingface.co/models/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${HF_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ inputs: prompt })
            });

            if (!response.ok) throw new Error('Failed to generate image');
            const blob = await response.blob();
            return URL.createObjectURL(blob);
        }

        async function enhancePromptWithQwen(prompt, systemPrompt = '') {
            const basePrompt = `<|im_start|>system
You are an expert image prompt engineer. Create a detailed, creative image generation prompt from the user's input. Keep it concise but descriptive, including style, lighting, and atmosphere details. Just provide the enhanced prompt without explanations.
${systemPrompt ? `\n\nAdditional instructions: ${systemPrompt}` : ''}
<|im_end|>
<|im_start|>user
${prompt}
<|im_end|>
<|im_start|>assistant`;

            const response = await fetch('https://api-inference.huggingface.co/models/Qwen/Qwen2.5-72B-Instruct', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${HF_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    inputs: basePrompt,
                    parameters: {
                        max_new_tokens: 500,
                        temperature: 0.9,
                        top_p: 0.95,
                        do_sample: true,
                        return_full_text: false,
                        stop: ["<|im_end|>", "</s>", "<|im_start|>"]
                    }
                })
            });

            const data = await response.json();
            return (data.generated_text || data[0]?.generated_text || data)
                .replace(/<\|im_start\|>assistant\n/g, '')
                .replace(/<\|im_end\|>/g, '')
                .trim();
        }

        // Event Listeners
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        window.onbeforeunload = function() {
            audioPlayer.pause();
        };

        // Initial welcome message
        window.onload = () => {
            appendMessage(translations[currentLanguage].welcome, 'assistant');
        };
    </script>
</body>
</html>
